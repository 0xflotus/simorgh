# Simorgh

[![Build Status](https://travis-ci.org/bbc/simorgh.svg?branch=latest)](https://travis-ci.org/bbc/simorgh) [![Test Coverage](https://api.codeclimate.com/v1/badges/cbca275e184057982f27/test_coverage)](https://codeclimate.com/github/bbc/simorgh/test_coverage) [![Known Vulnerabilities](https://snyk.io/test/github/bbc/simorgh/badge.svg)](https://snyk.io/test/github/bbc/simorgh) [![Maintainability](https://api.codeclimate.com/v1/badges/cbca275e184057982f27/maintainability)](https://codeclimate.com/github/bbc/simorgh/maintainability) [![Storybook](https://cdn.jsdelivr.net/gh/storybooks/brand@master/badge/badge-storybook.svg)](https://bbc.github.io/simorgh/)

The BBC websites are being rebuilt from the bottom up as ReactJS based Single Page Applications, that will (eventually) also be fully fledged Progressive Web Apps. This application also builds Accelerated Mobile Pages for every regular HTML page that it renders.

Simorgh will be used across the BBC World Service News websites ([some are already live](https://github.com/bbc/simorgh/wiki/Simorgh-Pages)), with tens of millions of users, and growing very fast.

We lean heavily on the component library called [Psammead](https://github.com/bbc/psammead/) that we also maintain. This library is also open source and used even more widely across the BBC.

## Before Installation
Please read:
CONTRIBUTING.md
## Installation

Install Node. [https://nodejs.org/en/](https://nodejs.org/en/). We use the version specified in `.nvmrc` and if you have a node version manager (nvm) you can run the following script to automatically change to the project supported version.

```
nvm use
```

Then you can run the following commands to install Simorgh

```
git clone git@github.com:bbc/simorgh.git
cd simorgh
npm install
```

## Local Development

To run this application locally, with hot-reloading, run

```
npm run dev
```

The application will start on [http://localhost.bbc.com:7080](http://localhost.bbc.com:7080). 

### Article pages

Article pages are served at routes of the format `/news/articles/:id` where id is the asset ID generated by the Content Management System.

FYI: [Article explaining the BBC's use of ids in URL](https://www.smashingmagazine.com/2014/05/responsive-design-begins-with-the-url/)

These two News articles are available on the Test environment of our CMS, as well as locally, so are often used for testing:

- [http://localhost.bbc.com:7080/news/articles/c6v11qzyv8po](http://localhost.bbc.com:7080/news/articles/c6v11qzyv8po)
- [http://localhost.bbc.com:7080/persian/articles/c4vlle3q337o](http://localhost.bbc.com:7080/persian/articles/c4vlle3q337o).

We are also serving AMP HTML pages at the route `/news/articles/:id.amp` [https://www.ampproject.org](https://www.ampproject.org)

- [http://localhost.bbc.com:7080/news/articles/c6v11qzyv8po.amp](http://localhost.bbc.com:7080/news/articles/c6v11qzyv8po.amp)
- [http://localhost.bbc.com:7080/persian/articles/c4vlle3q337o.amp](http://localhost.bbc.com:7080/persian/articles/c4vlle3q337o.amp).

### Front pages

World Service front pages are served in the format `/:service` where `service` represents a World Service site:

- [http://localhost.bbc.com:7080/igbo](http://localhost.bbc.com:7080/igbo)
- [http://localhost.bbc.com:7080/pidgin](http://localhost.bbc.com:7080/pidgin)

The World Service front pages follow the article format for AMP too, being available at `/:service.amp`:

- [http://localhost.bbc.com:7080/igbo.amp](http://localhost.bbc.com:7080/igbo.amp)
- [http://localhost.bbc.com:7080/pidgin.amp](http://localhost.bbc.com:7080/pidgin.amp)

### Other page types
You can find other pages types by looking through our routes and their associates regexes, but we suggest you start with the above then have a look at the core of the application to understand and find the other routes.

### Storybook (UI Development Environment/Style Guide)

We use Storybook for developing components in isolation from the Simorgh Application. You can access this at [https://bbc.github.io/simorgh/](https://bbc.github.io/simorgh/)

To run locally `npm run storybook`, it will then be available at [http://localhost.bbc.com:9001/](http://localhost.bbc.com:9001/). Introduction to and documentation for Storybook is here: [https://storybook.js.org/basics/introduction/](https://storybook.js.org/basics/introduction/).

When viewing Video stories locally, make sure to use a BBC domain, as outlined in the [changing request location section](https://github.com/bbc/simorgh#changing-request-location). Video will not work in the hosted version of Storybook linked above for this reason.

We also use [Chromatic QA](https://docs.chromaticqa.com/) to run cross-browser testing on our stories.

## Production build locally

To run this application locally with a production build, run:
`npm run build && npm run start`.

We use `npm run build` locally which bundles the application pointing at localhost for data and static assets.

## Using environment builds locally

This is mainly used for debugging `latest` using the TEST and LIVE environment bundles. Ensure that the bundles exist in the static asset location for the correct environment before starting to debug.

To run TEST bundles on localhost:

- In `envConfig/test.env` change the values of:
  - `LOG_DIR='/var/log/simorgh'` to `LOG_DIR='log'`
  - `COSMOS_DIALS_PATH='/etc/cosmos-dials/dials.json'` to `COSMOS_DIALS_PATH='dials.json'`
- Then run `rm -rf build && npm run build:test && npm run start`
- Visit a test article: http://localhost.bbc.com:7080/news/articles/c0g992jmmkko

To run LIVE bundles on localhost:

- In `envConfig/live.env` change the values of:
  - `LOG_DIR='/var/log/simorgh'` to `LOG_DIR='log'`
  - `COSMOS_DIALS_PATH='/etc/cosmos-dials/dials.json'` to `COSMOS_DIALS_PATH='dials.json'`
- Then run `rm -rf build && npm run build:live && npm run start`
- Visit a live article: http://localhost.bbc.com:7080/news/articles/c8xxl4l3dzeo

If these urls do not work, you may need to add a hosts file entry (`/etc/hosts` or `C:\Windows\System32\drivers\etc\hosts`):

```
127.0.0.1 localhost.bbc.co.uk
127.0.0.1 localhost.bbc.com
```

## Changing request location

Some features perform differently dependant on whether a user is located within the UK or internationally. You can explicitly request a specific version by accessing Simorgh via a specific localhost BBC domain:

- UK version: [http://localhost.bbc.co.uk:7080/news/articles/c0000000001o](http://localhost.bbc.co.uk:7080/news/articles/c0000000001o)
- International version: [http://localhost.bbc.com:7080/news/articles/c0000000001o](http://localhost.bbc.com:7080/news/articles/c0000000001o)

## Production build on CI

On deployment `npm run build:ci` is run in the CI environment which creates bundles for both the `test` and `live` environments. On the two environments the `.env.test` or `.env.live` files overwrite the `.env` file which is used to run the application with the correct bundles.

### Bundle analysis reports

Every run of `npm run build` will update the bundle analysis files in the repo. To view a breakdown of the bundle size, open the generated html report in a browser `./reports/webpackBundleReport.html` This is generated via `webpack-bundle-analyzer`. The data is also available as json `./reports/webpackBundleReport.json`.

## Tests

### Linting and unit tests

We have linting with the [Airbnb styleguide](https://github.com/airbnb/javascript/tree/master/react) and we use [Prettier](https://github.com/prettier/prettier) as a code formatter. They can be run with `npm run test:lint`.

We have [Jest](https://facebook.github.io/jest) unit tests that can be run with `npm run test:unit`.

`npm test` runs both sets of these.

### End-to-end tests

#### Main application

We use [Cypress](https://www.cypress.io/) for our end-to-end tests. For running the tests locally, run this single command:

```
npm run test:e2e
```

It will spin up a production server on port 7080 and run the Cypress tests against that.

Further details on using the Cypress CLI can be found at https://docs.cypress.io/guides/guides/command-line.html

Cypress can be run interactively using `npm run test:e2e:interactive`. This loads a user interface which easily allows for indivdual tests to be run alongside a visual stream of the browser, as the tests run.

#### Running e2e in the UK against LIVE
**This affects developers based in the UK only (but may affect you if you're using a VPN routing through the UK)**

Cypress .visit() function is locked to visiting a single domain per test. This becomes problematic when you launch the e2e tests from within the UK, due to redirects from `.com` to `.co.uk`. By default cypress tests will run as if they were ran outside of the uk. In order to run these tests from the UK you have to pass in the `UK` Cypress environment variable to the tests. This will replace the URL endings to `.co.uk`, which will allow you to run these tests successfully.

Here is an example command:

```
CYPRESS_APP_ENV=test CYPRESS_UK=true npm run cypress:interactive
```

### Lighthouse Best Practice tests

We use [Lighthouse](https://github.com/googlechrome/lighthouse) to test the performance of our page. However these have been moved out of Simorgh down to our own internal CD processes. This allows us to run these tests on a more accurate depiction of Simorgh. You are free to run lighthouse on your own from your Chrome browser or use the Node Lighthouse CLI.

### Why is it called Simorgh?!

Named Simorgh after the Persian mythological bird. The Simorgh is the amalgam of many birds (and in some accounts other animals) into one.

Happily, a metaphor which seemed apt for offering all BBC articles in one solution is perhaps now even more appropriate as the application evolves to support more content types. Itâ€™s also a clear reference to the international nature of our teams, but also to the desire to ensure articles (and everything which has followed) works for users in all languages the BBC supports.

It is also a unique name which is practical and, more superficially, the bird is very pretty.