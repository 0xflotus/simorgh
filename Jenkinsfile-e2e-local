#!/usr/bin/env groovy
library 'Simorgh'

def nodeImageVersion = "12.13.0"
def nodeImage = "329802642264.dkr.ecr.eu-west-1.amazonaws.com/bbc-news/node-12-lts:${nodeImageVersion}"

// Run latest every 3 hours
def cron_string = env.BRANCH_NAME == "latest" ? "0 */3 * * *" : ""

def stageHasFailed = false;

node {
    properties(
        [
            buildDiscarder(
                logRotator(
                    daysToKeepStr: '10',
                    artifactDaysToKeepStr: '10'
                )
            ),
            pipelineTriggers([cron(cron_string)]),
            parameters(
                [
                    string(defaultValue: 'latest', name: 'BRANCH')
                ]
            )
        ]
    )
    timeout(time: 240, unit: 'MINUTES') {
        withEnv([
            'CI=true'
        ]) {
            cleanWs() // Clean the workspace

            Simorgh.checkoutAndBuild("${params.BRANCH}")
            dir ("${env.APP_DIR}") {
                docker.image("${nodeImage}").inside('--ipc host') {
                    try {
                        Simorgh.installNodeModules()
                        stage ('Localhost Tests') {
                            Simorgh.runLocalAndProductionTests()
                        }
                    } finally {
                        Simorgh.e2esPostBuildSteps('local')
                    }
                }
            }
        }
    }
}
